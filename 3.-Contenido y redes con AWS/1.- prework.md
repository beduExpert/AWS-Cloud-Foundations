# Prework Sesi칩n 3



## Introducci칩n
El proceso de transferencia de datos en cualquier infraestructura se efect칰a por medio de la red. Si bien la nube quita mucho trabajo a la hora de configurar redes en comparaci칩n a redes on premise de dispositivos de marca Cisco por ejemplo, a칰n as칤 se deben generar configuraciones de redes pues no siempre todos los dispositivos, servicios o instancias conectadas a una red deben tener comunicaci칩n con otros, todo depender치 de la arquitectura de la soluci칩n pero una arquitectura b치sica puede ser la basada en [DMZ](https://searchsecurity.techtarget.com/definition/DMZ).

Las redes requieren direcciones IP para funcionar, pero para nosotros como humanos no es c칩modo trabajar con direcciones IP, requerimos algo m치s intuitivo, de esa necesidad surge el protocolo DNS y AWS cuenta con 칠l.

Gracias a las redes y protocolos DNS es posible generar balanceadores de carga es decir servicios capaces de brindar una 칰nica cara al cliente para recibir peticiones para despu칠s redireccionarlas o despacharlas a un servidor espec칤fico de las decenas que pueden estar conectados con el balanceador de carga.

### 1. Objetivo 游꿢
- Conocer las opciones que ofrece AWS para la gesti칩n de redes y como interactuan con otros servicios.

### 2. Instrucciones 游늶
Conviene ver los siguientes videos para reafirmar algunos conceptos que ser치n 칰tiles.
-  [HTTP Load Balancing with Nginx](https://www.youtube.com/watch?v=SpL_hJNUNEI)

-[쯈u칠 es un DNS?](https://community.icann.org/download/attachments/62395695/1-ICANN58-Mar2017-What-is-the-Domain-Name-System.pdf?version=1&modificationDate=1489502569000&api=v2)

- [Understanding How DNS Works in Depth](https://www.youtube.com/watch?v=T-eghY-9WdE)

- [Nuevas Edge Locations](https://aws.amazon.com/es/about-aws/whats-new/2020/09/amazon-cloudfront-launches-in-two-new-countries-mexico-and-new-zealand/)

- [쯈u칠 es un CDN?](https://www.youtube.com/watch?v=52VSbXBlfdc)

- [쯈u칠 es DHCP?](https://www.ionos.es/digitalguide/servidores/configuracion/que-es-el-dhcp-y-como-funciona/)

- [쯇or qu칠 es importante hacer subnetting?](https://www.ionos.com/digitalguide/server/know-how/subnetting-how-do-subnets-work/)

### 3. Desarrollo 游늼

# Amazon Virtual Private Cloud (VPC)


AWS VPC es una red definida por software (red virtual) aislada de otras redes virtuales optimizada para el transporte de masivas cantidades de paquetes de red hacia, desde y entre regiones de AWS. En una VPC es posible conectar recursos de AWS como instancias EC2, como toda red esta red puede ser dividida en subredes para mejor administraci칩n del espacio de direcciones IP.
Hay una red virtual VPC generada en cada regi칩n por defecto, cuenta con conexi칩n hacia y desde internet con al finalidad de conectar servicios de AWS r치pidamente.
Dependiendo de la arquitectura de las soluciones a desplegar no siempre ser치 deseado que los recursos puedan ser accedidos desde internet directamente, t칤picamente el ejemplo es la conexi칩n a base de datos, las bases de datos normalmente se encuentran asiladas del acceso desde internet directamente siendo accedidas por medio de un servidor web en las llamadas DMZ.
![6c0a3d0d798e574ea019afb082e6662a.png](6c0a3d0d798e574ea019afb082e6662a.png)


Las redes virtuales VPC se conforman de un gran bloque de direcciones IP, la VPC por defecto cuenta con una m치scara de subred /16 (es posible conectar 65,534 dispositivos con este espacio de direcciones IP), se cuenta con la suficiente flexibilidad para generar redes VPC con m치scara de subred de tama침o 28.

Para mejorar el tr치fico de las redes y mejorar la administraci칩n del espacio de direcciones IP las VPC pueden ser divididas en espacios de direcciones IP mas peque침os, estos espacios son llamados `subredes`, la divisi칩n del espacio de direcciones IP en VPC corresponde a la notaci칩n [CIDR](https://www.youtube.com/watch?v=z07HTSzzp3o) (Classless Inter-Domain Routing) tradicionalmente usada a la hora de administrar cualquier red.
En el siguiente ejemplo se ver como un espacio de direcciones IP puede ser manejado en redes mas peque침as.
![74b4fcd900fc89abf4ea4b2b5b65cb11.png](74b4fcd900fc89abf4ea4b2b5b65cb11.png)


Para la mejora de la seguridad entre subredes es posible definir reglas que dicten que tipo de tr치fico puede fluir entre ellas tanto de entrada como de salida por medio de ACL (Access Control List), las ACL se encuentran definidas a nivel de VPC y pueden ser asociadas con una o mas subredes.
Para manejo mas granular de la seguridad de tr치fico de red es posible definir reglas que regulen el tipo de tr치fico no solo entre subredes si no entre instancias EC2 (o instancias RDS o Lambdas por ejemplo) por medio de los `Security Groups`, pueden ser vistos como un firewall muy b치sico asociado a una instancia, as칤 es posible definir un servidor Web EC2 con cara hacia internet, en el Security Group asociado a esta instancia EC2 se  permite solo el acceso desde internet por los puertos 80 y 443.

![e23cf7b9e8d458ba8d749a9747cd2f42.png](e23cf7b9e8d458ba8d749a9747cd2f42.png)

A continuaci칩n observa el detalle de un Security Group definiendo reglas de entrada de tr치fico a la instancia solo a tr치fico http y https:
![19e7d03a3058fee9937a9807ee65a4e0.png](19e7d03a3058fee9937a9807ee65a4e0.png)

Para conectar las redes VPC a internet se hace uso de un `Internet Gateway`, un IG es un componente de VPC de escala horizontal, redundante y de alta disponibilidad sin riesgos de disponibilidad ni limitaciones de ancho de banda.

Al hablar de subredes es necesario hablar de routeo, AWS define tablas de routeo que dictan como ser치 dirigido el tr치fico desde y hacia internet, por defecto todas las subredes de una VPC pueden comunicarse con otras subredes sin definir expl칤citamente reglas de routing, las reglas de routing aplican para el trafico entrante y saliente de la subred.
Una red privada es definida si no tiene routing de su tr치fico hacia un Internet Gateway sin embargo muchas veces es necesario tener acceso para descargar software o actualizaciones en las instancias, para lo cual hay un mecanismo que permite conectar estas instancias en redes privadas hacia internet solamente, el mecanismo es un llamado `NAT Gateway`, con 칠l se puede definir en la tabla de routeo que si una instancia desea conectarse a internet desde una red privada en lugar de hacerlo por un Internet Gateway de la VPC (El internet Gateway es bidireccional) lo haga por medio de un NAT Gateway, con ellos es posible tener las instancias privadas conectadas hacia internet.

Para dejar mas claro los conceptos tocados, analicemos el siguiente diagrama de la Universidad de Cornell.
![Diagrama](https://cpb-us-e1.wpmucdn.com/blogs.cornell.edu/dist/b/5998/files/2016/04/Typical-Cornell-VPC-Configuration-1f8gtsn.png)

Podemos ver que la configuraci칩n tiene una VPC con mascara 22, lo que significa es posible tener disponibles 1022 IP para host, esta VPC tiene su Internet Gateway para comunicar las redes publicas hacia internet y desde internet.
Ellos configuran 2 redes p칰blicas (que pueden ser accedidas desde internet) y dos privadas (no pueden ser accedidas desde internet directamente), hay que notar que cada par esta alojado en zonas de disponibilidad distintas, esto para brindar cierta tolerancia a fallos. 
Se observan tambi칠n las subredes, cada una con un espacio de direcciones IP de 252 hosts ya que cada una tiene una mascara 24, con lo que se pueden tener 252 dispositivos que necesiten una IP, no necesariamente tienen que ser 252 instancias, puede haber instancias que sean configuradas con 2 direcciones IP o m치s.
Otro elemento a destacar es el NAT gateway que siempre reside en una red p칰blica, con 칠l las redes privadas tendr치n acceso hacia internet, muchas veces para configurar un servidor se requiere acceso a repositorios de software externos.
Finalmente VPG (Virtual Private Gateway) da la flexibilidad de conectar por medio de una VPN las instalaciones de la propia universodad con AWS. 

쯈u칠 hacer y tomar en cuenta a la hora de construir una VPC?
Las VPC tienen un l칤mite, AWS por defecto limita a 5 VPC por regi칩n, este l칤mite se puede superar pero solo hasta 100 VPCs, de la misma forma, el n칰mero de bloques de direcciones IP permitidos en cada VPC es un m치ximo de 50 sin poder aumentar este l칤mite.
Al establecer el tama침o del bloque VPC y de las subredes se tiene que tomar en cuenta que este valor ya no puede ser modificado, la VPC y las subredes ya se quedan con el numero de IP definidas desde la creaci칩n, as칤 que si se estima un crecimiento r치pido de recursos en una VPC es mejor ser generoso con el bloque de direcciones IP.
Tomar en cuenta que las subredes pertenecen a una zona de disponibilidad.
No todas las redes deben tener acceso directo desde internet, hay que ser cuidadoso a la hora de configurar el routing para asegurar que las redes definidas como privadas en realidad lo sean.
En la mayor칤a de los casos es buena pr치ctica manejar m칰ltiples capas de acceso en la infraestructura, ej: se tiene una VPC para producci칩n subdividida en una red p칰blica destinada a los servidores web y otra subred privada para las bases de datos.


# Conectividad con VPNs y Amazon Direct Connect
# TODO Completar
Una red p칰blica es b치sicamente el tipo de red que proporciona un servicio de conexi칩n o telecomunicaciones a cambio del pago de una cuota de servicio. 
Existen redes privadas en organizaciones con multitud de dispositivos ubicados dentro de un recinto, conectados a switchs a trav칠s de cables. En estas redes privadas, un usuario que sea externo a esta red no podr치 conectarse a ella para acceder a Internet, el acceso solamente esta restringido a los usuarios que est칠n en el interior de ella, en la mayor칤a de los casos claro.

Es la soluci칩n de AWS para conectar la red on-premises a la red de AWS en un enlace dedicado.

![bc0712eb21de5e97c7963e8573afb3fa.png](bc0712eb21de5e97c7963e8573afb3fa.png)


# Amazon Route 53
Amazon Route 53 proporciona una facilidad para registrar nombres de dominio, un servicio de Sistema de Nombres de Dominio (DNS ) para que los nombres de dominio se traduzcan a direcciones IP.

Al teclear example.com un servidor debe responder a la petici칩n, pero los dispositivos de red funcionan con direcciones IP, para traducir example.com a una direcci칩n IP con la que routers puedan dirigir la petici칩n al servidor correcto el DNS buscar치 en su propia tabla la correspondencia de dominio y direcci칩n IP, si el no la tiene preguntar치 a otro servidor hasta encontrar la equivalencia. 
![dns.png](dns.png)
En Route53 es posible dar de alta m칰ltiples dominios. En el siguiente ejemplo son 2.
![c7194006d6635fd5b379abb107477529.png](c7194006d6635fd5b379abb107477529.png)

Al ingresar al detalle de la zona (una zona es un dominio DNS manejado por AWS) se visualizan los distintos tipos de registros DNS, MX, TXT, A..
![8fc7a1c5f2fe539882097542a79ef980.png](8fc7a1c5f2fe539882097542a79ef980.png)
Al querer generar un nuevo registro en el DNS (tal ves se requiere agregar un nuevo subdominio para acceder a una nueva p치gina web), ser치 necesario seleccionar entre varias de pol칤tica de redireccionamiento.
![91f06bbe52ec24a28de6bb7aa58c5d3c.png](91f06bbe52ec24a28de6bb7aa58c5d3c.png)

El routing simple redirige las peticiones a un servidor.
La opci칩n ponderado dirige el tr치fico a varios recursos en las proporciones diferentes, 80% peticiones al servidor1.com y 20% al servidor2.com.
Geolocalizaci칩n permite dirigir tr치fico a recursos y/o servidores basados en la localizaci칩n f칤sica del cliente.
Por latencia verifica la petici칩n y la redirige a los recursos AWS con la regi칩n con menos latencia.
Por conmutaci칩n por error ayuda a implementar una estrategia de fail-over de tipo activo/pasivo.
Respuesta de varios valores redirige el tr치fico de forma pseudo aleatoria entre hasta 8 direcciones IP.

Si se selecciona un registro simple se pueden agregar valores est치ndar del protocolo DNS como CNAME, TXT, A, pero se vuelve interesante la integraci칩n de AWS con servicios como Elastic Beanstalk, Balanceadores de carga, Buckets S3 configurados para hosting web, AWS API Gateway, AWS Cloud Front, lo que da mucha facilidad a la hora de definir las reglas para resolver direcciones IP. 


# Elastic Load Balancing
Al tener cargas de trabajo grandes surge la necesidad de distribuir la carga de trabajo entre varios servidores, la distribuci칩n puede ser hecha por medio de un balanceador de carga. Imaginar un e-commerce en 칠poca navide침a, las peticiones al e-commerce subir치n y un solo servidor posiblemente no tenga lo necesario para atender todos los posibles compradores que se conectan a 칠l, es posible optar por una estrategia de escalamiento horizontal para generar m칰ltiples instancias del e-commerce (siempre y cuando la arquitectura del e-commerce lo permita). Al contar con m칰ltiples servidores operando se debe hacer uso de un balanceador de carga encargado de redirigir las peticiones a un servidor dado, de cara al cliente solo ver치 una sola direcci칩n IP pero en realidad son m칰ltiples servidores los que est치n atendiendo las peticiones.
![d92ea053878e3afa61972554617a479d.png](d92ea053878e3afa61972554617a479d.png)


AWS cuenta con balanceadores con modelo PaaS con el servicio Elastic Load Balancing. 
Elastic Load Balancing cuenta con tres tipos de balanceadores de carga: Application Load Balancers, Network Load Balancers y Classic Load Balancers.  
Application Load Balancers se utilizan para redireccionar el tr치fico HTTP / HTTPS (o Capa 7). Los Balanceadores de carga de red y los Balanceadores de carga cl치sicos se utilizan para redireccionar el tr치fico TCP (o Capa 4).

Para generar un balanceador de carga en AWS ir a la seccion칠 EC2 y seleccionaremos `Balanceadores de carga`

![c462c5a456e53527d62a2f5948a8bb14.png](c462c5a456e53527d62a2f5948a8bb14.png)

Seleccionar el tipo de balanceador de carga, ya dependiendo del tipo seleccionado estar치n disponibles diferentes opciones de configuraci칩n.
![57efe04c5d923427044d4f18bf673898.png](57efe04c5d923427044d4f18bf673898.png)

En caso de seleccionar Application Load Balancer se tiene que especificar un nombre para el balanceador de carga (1a), si ser치 un balanceador de carga interno para manejar tr치fico con origen y destino entre subredes o externo para manejar tr치fico de origen desde internet (1b), se debe especificar si se requiere trabajar con ipv6 adem치s de ipv4 (1c), especificar los puertos de escucha (1d), por el momento solo se pueden manejar los protocolos http y https con posibilidad para seleccionar un n칰mero de puerto no est치ndar, por 칰ltimo seleccionaremos la VPC dentro de la que se habilitar치 el balanceador teniendo que seleccionar las zonas de disponibilidad y las subredes entre las que habr치 balanceo de carga, muy importante tomar en cuenta a la hora de dise침ar el balanceo de carga, solo se puede escoger una subred por zona de disponibilidad.
![492aad0556bce65fd0ce8d1f49e02ca9.png](492aad0556bce65fd0ce8d1f49e02ca9.png)

En la siguiente secci칩n se debe seleccionar como se debe manejar el cifrado de la conexi칩n, se brinda la opci칩n de subir un certificado SSL  propio en caso de ya contar con uno de un proveedor externo o se puede escoger alguno ya hecho en AWS Certificate Manager (1a), despu칠s  seleccionar  los protocolos de cifrado que se usar치n para establecer el canal seguro (1b)
![f4e33fc1a49e7c16e94649e4de0dfc0f.png](f4e33fc1a49e7c16e94649e4de0dfc0f.png)

Dependiendo de `security policy` seleccionada ser치n los protocolos de cifrado que dispondr치 el balanceador de carga para negociar con los clientes que se conectar치n.
![3540de05ee6cd4303fa1d14709b7e1f1.png](3540de05ee6cd4303fa1d14709b7e1f1.png)

En la siguiente fase seleccionar entre grupos de seguridad, ello da control sobre las direcciones IP de origen y destino permitidas para el balanceador de carga
![06e52998bd1df044740295a9bb9c3110.png](06e52998bd1df044740295a9bb9c3110.png)

Es necesario seleccionar el grupo de servidores hacia donde ser치n transferidas las peticiones.
![dd1e50179821fa7d4b947e1ca7f415d6.png](dd1e50179821fa7d4b947e1ca7f415d6.png)

Seleccionaremos las instancias (se pueden seleccionar direcciones IP o funciones de AWS Lambda tambi칠n dependiendo lo seleccionado en Target Type en el paso anterior) que atender치n las peticiones redirigidas por el balanceador.
![f766471b601616db9e749ae2c885ac30.png](f766471b601616db9e749ae2c885ac30.png)




# Amazon CloudFront
Es el servicio para la entrega de contenido (Content Delivery Network) para distribuci칩n global de v칤deo, datos, aplicaciones de baja latencia.
Para poder entregar el contenido con baja latencia, Amazon cuenta con los llamados _edge locations_,  cuando un usuario solicita un contenido es dirigido a un edge location que provee la latencia mas baja de forma que el contenido sea entregado con el mejor performance posible. Se cuenta con 200  puntos de entrega de contenido distribuidos en 34 pa칤ses y 77 ciudades
![a23e2775f2471e84ddc3e8f943ddd6b5.png](a23e2775f2471e84ddc3e8f943ddd6b5.png)
Soporta todo el contenido que pueda ser provisto mediante HTTP o HTTPS, incluyendo HTML, JS, CSS, audio, video, media y binarios.
CloudFront se integra con AWS Shield para mitigaci칩n de ataques DDoS, tambi칠n con AWS WAF para mitigaci칩n de ataques SQL Injection, XSS entre otros, para brindar transporte de datos seguro con https se integra con AWS Certificate Manager.
Al momento de configurar el servicio CloudFront se debe especificar el origen de los datos para replicar a la edge location, el origen puede ser un Bucket S3 configurado en modo web hosting, un balanceador de carga o una instancia EC2.

El siguiente ejemplo muestra una distribuci칩n con origen de datos desde un Bucket S3 configurado como web hosting.
![61a100bb9801163366beb69e6f57ef72.png](61a100bb9801163366beb69e6f57ef72.png)



Los casos de uso destacados son:
Servir a los usuarios finales un sitio web est치tico con posibilidad de uso de https y dominio propio, distribuci칩n de paquetes de software, en general es recomendado si los usuarios finales se encuentran distribuidos geogr치ficamente por todo el mundo.
